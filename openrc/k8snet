#!/sbin/openrc-run
description="Sets up networking in firecracker"
iface="${iface:-eth0}"

depend() {
    provide net
    before hostname
}

start() {
    source /etc/cmdline

    if [ -n "$KOPT_hostname" ]; then
        ebegin "Writing /proc/cmdline hostname"
        echo "$KOPT_hostname" > /etc/hostname
        eend $?
    fi

    ip link set dev lo up

    ip link set dev "$iface" up
    ip addr add 192.168.69.2/30 dev "$iface"
    ip route add default via 192.168.69.1

    if [ -n "$KOPT_k8s_mtu" ]; then
        ebegin "Setting $iface MTU address from /proc/cmdline"
        ip link set dev "$iface" mtu "$KOPT_k8s_mtu"
        eend $?
    fi

    if [ -n "$KOPT_k8s_ip" ]; then
        ebegin "Setting $iface IP address from /proc/cmdline"
        ip addr add "$KOPT_k8s_ip" dev "$iface"
        eend $?
    fi

    if [ -n "$KOPT_k8s_gw" ]; then
        ebegin "Setting default gateway from /proc/cmdline"
        ip route add default via "$KOPT_k8s_gw"
        eend $?
    fi

    if [ -n "$KOPT_resolvconf" ]; then
        ebegin "Writing /etc/resolv.conf from /proc/cmdline "
        echo "$KOPT_resolvconf" | base64 -d > /etc/resolv.conf
        eend $?
    fi
}
